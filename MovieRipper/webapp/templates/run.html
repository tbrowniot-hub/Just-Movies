{% extends "_layout.html" %}
{% block title %}Run Â· MovieRipper{% endblock %}
{% block content %}
<section class="card">
  <h2>Run Queue</h2>
  <form id="start-form" class="form-grid">
    <label>Queue path
      <input id="queue-path" name="queue_path" value="MovieRipper/movie_queue.json" />
    </label>
    <label>Config path
      <input id="config-path" name="config_path" value="config.json" />
    </label>
    <div id="run-error" class="error hidden"></div>
    <div class="row gap">
      <button id="start-btn" type="submit">Start</button>
      <button id="stop-btn" type="button" class="danger">Stop</button>
    </div>
  </form>

  <p id="big-status" class="badge idle">Idle</p>
  <p id="run-meta" class="muted">No active run.</p>
</section>

<section class="card">
  <div class="row gap">
    <h3>Logs</h3>
    <label><input id="pause-scroll" type="checkbox" /> Pause autoscroll</label>
  </div>
  <pre id="logs-box" class="logs"></pre>
</section>
{% endblock %}
{% block scripts %}
<script>
const startForm = document.getElementById('start-form');
const startBtn = document.getElementById('start-btn');
const stopBtn = document.getElementById('stop-btn');
const bigStatus = document.getElementById('big-status');
const runMeta = document.getElementById('run-meta');
const logsBox = document.getElementById('logs-box');
const pauseScroll = document.getElementById('pause-scroll');
const queuePathInput = document.getElementById('queue-path');
const configPathInput = document.getElementById('config-path');
const runError = document.getElementById('run-error');

const LS_QUEUE_PATH = 'movieripper.run.queue_path';
const LS_CONFIG_PATH = 'movieripper.run.config_path';
const LS_INDEX_PATH = 'movieripper.queue.index_path';
const DEFAULT_INDEX_PATH = 'MovieRipper/movie_index.json';

function readStoredValue(key, fallback) {
  const value = localStorage.getItem(key);
  return value && value.trim() ? value : fallback;
}

function setError(message) {
  if (message) {
    runError.textContent = message;
    runError.classList.remove('hidden');
  } else {
    runError.textContent = '';
    runError.classList.add('hidden');
  }
}

async function validatePaths() {
  const res = await fetch('/api/v1/run/paths', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      queue_path: queuePathInput.value,
      config_path: configPathInput.value,
      index_path: readStoredValue(LS_INDEX_PATH, DEFAULT_INDEX_PATH),
    }),
  });
  if (!res.ok) {
    setError('Unable to verify file paths right now.');
    return false;
  }

  const payload = await res.json();
  if (!payload.config_exists) {
    setError(`Config file not found at ${payload.config_path}. Create config.json from config.example.json, then try again.`);
    return false;
  }
  if (!payload.queue_exists) {
    setError(`Queue file not found at ${payload.queue_path}. Build and save a queue from the Queue page first.`);
    return false;
  }

  setError('');
  return true;
}

queuePathInput.value = readStoredValue(LS_QUEUE_PATH, queuePathInput.value);
configPathInput.value = readStoredValue(LS_CONFIG_PATH, configPathInput.value);
queuePathInput.addEventListener('input', () => localStorage.setItem(LS_QUEUE_PATH, queuePathInput.value));
configPathInput.addEventListener('input', () => localStorage.setItem(LS_CONFIG_PATH, configPathInput.value));

startForm.onsubmit = async (e) => {
  e.preventDefault();
  localStorage.setItem(LS_QUEUE_PATH, queuePathInput.value);
  localStorage.setItem(LS_CONFIG_PATH, configPathInput.value);

  const canStart = await validatePaths();
  if (!canStart) {
    return;
  }

  const fd = new FormData(startForm);
  const res = await fetch('/api/v1/run/start', {method: 'POST', body: fd});
  if (!res.ok) {
    const payload = await res.json();
    setError(payload.detail || 'Unable to start');
    runMeta.textContent = payload.detail || 'Unable to start';
  }
};

stopBtn.onclick = async () => {
  await fetch('/api/v1/run/stop', {method: 'POST'});
};

function updateButtons(status) {
  const running = !!status.running;
  startBtn.disabled = running;
  stopBtn.disabled = !running;
}

setInterval(async () => {
  const status = await (await fetch('/api/v1/status')).json();
  const logs = await (await fetch('/api/v1/logs?tail=200')).json();

  const step = status.step || 'idle';
  const running = !!status.running;
  bigStatus.textContent = running ? `Running: ${step}` : `Idle: ${step}`;
  bigStatus.className = `badge ${running ? 'running' : 'idle'}`;

  const current = status.current || '-';
  const total = status.total || '-';
  const title = status.title || '-';
  const clz = status.clz_index || '-';
  const imdb = status.imdb_id || '-';
  runMeta.textContent = `Queue: ${queuePathInput.value} | Config: ${configPathInput.value} | Item ${current}/${total} | ${title} | CLZ ${clz} | IMDb ${imdb}`;

  logsBox.textContent = (logs.lines || []).join('\n');
  if (!pauseScroll.checked) {
    logsBox.scrollTop = logsBox.scrollHeight;
  }

  updateButtons(status);
}, 1000);
</script>
{% endblock %}
